<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodExpress - Narsinghpur Food Delivery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #fff7ed 0%, #ffe4e6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 15px;
        }

        .logo h1 {
            font-size: 36px;
            font-weight: 900;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .logo p {
            color: #6b7280;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            background: #e5e7eb;
            color: #4b5563;
        }

        .tab-btn.active {
            background: #f97316;
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
            background: #f9fafb;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f97316;
            background: white;
        }

        .password-input {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 20px;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            box-shadow: 0 8px 24px rgba(249, 115, 22, 0.4);
            transform: translateY(-2px);
        }

        .admin-info {
            margin-top: 20px;
            padding: 15px;
            background: #dbeafe;
            border-radius: 12px;
        }

        .admin-info p {
            font-size: 12px;
            color: #1e3a8a;
            margin-bottom: 5px;
        }

        .admin-info code {
            font-family: monospace;
            background: #bfdbfe;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header.admin { background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); }
        .header.restaurant { background: linear-gradient(135deg, #059669 0%, #0d9488 100%); }
        .header.delivery { background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%); }
        .header.user { background: linear-gradient(135deg, #f97316 0%, #dc2626 100%); }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 900;
        }

        .header p {
            opacity: 0.9;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-white {
            background: white;
            color: #1f2937;
        }

        .btn-white:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-green {
            background: #22c55e;
            color: white;
        }

        .btn-red {
            background: #ef4444;
            color: white;
        }

        .btn-yellow {
            background: #eab308;
            color: #1f2937;
        }

        .btn-map {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-map:hover {
            background: #2563eb;
        }

        /* Map Modal */
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .map-container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 90%;
            width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .map-canvas {
            width: 100%;
            height: 500px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f3f4f6;
            position: relative;
            overflow: hidden;
        }

        .map-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .map-info {
            margin-top: 16px;
            padding: 12px;
            background: #f3f4f6;
            border-radius: 8px;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            color: #4b5563;
        }

        .tab.active {
            background: #7c3aed;
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card h2 {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #1f2937;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        /* Item Cards */
        .item-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }

        .item-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .item-card-content {
            padding: 16px;
        }

        /* Status Badge */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 700;
        }

        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-accepted { background: #dbeafe; color: #1e3a8a; }
        .badge-assigned { background: #e9d5ff; color: #6b21a8; }
        .badge-picked { background: #c7d2fe; color: #3730a3; }
        .badge-delivered { background: #d1fae5; color: #065f46; }
        .badge-open { background: #d1fae5; color: #065f46; }
        .badge-closed { background: #fee2e2; color: #991b1b; }

        /* Approval Card */
        .approval-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .approval-info h3 {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .approval-info p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .approval-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }

        .btn-approve {
            background: #22c55e;
            color: white;
        }

        .btn-reject {
            background: #ef4444;
            color: white;
        }

        /* Restaurant Card */
        .restaurant-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s;
        }

        .restaurant-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }

        .restaurant-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .restaurant-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #fb923c 0%, #ef4444 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .restaurant-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Menu Item Small */
        .menu-item-small {
            display: flex;
            gap: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .menu-item-small img {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            object-fit: cover;
        }

        .menu-item-info {
            flex: 1;
        }

        .menu-item-info h3 {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .price {
            color: #059669;
            font-weight: 700;
        }

        /* Cart */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
        }

        .qty-btn.minus {
            background: #fee2e2;
            color: #dc2626;
        }

        .qty-btn.plus {
            background: #d1fae5;
            color: #059669;
        }

        /* Bill Summary */
        .bill-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .bill-total {
            border-top: 2px solid #e5e7eb;
            padding-top: 12px;
            margin-top: 12px;
            font-weight: 700;
            font-size: 18px;
        }

        /* Location Display */
        .location-box {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .location-box p {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 4px;
        }

        /* Order Card */
        .order-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .order-info h3 {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .order-info p {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        /* Payment Methods */
        .payment-grid {
            display: grid;
            gap: 12px;
        }

        .payment-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-btn.cod {
            background: #22c55e;
            color: white;
        }

        .payment-btn.online {
            background: #3b82f6;
            color: white;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* QR Code Display */
        .qr-display {
            text-align: center;
            margin-top: 16px;
        }

        .qr-display img {
            width: 200px;
            height: 200px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin: 12px auto;
        }

        /* Wallet Display */
        .wallet-box {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .wallet-box h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .wallet-box .amount {
            font-size: 32px;
            font-weight: 900;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
            }

            .grid, .grid-2 {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .tab {
                flex-shrink: 0;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid #22c55e;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        /* Alarm Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .alarm-notification {
            animation: shake 0.5s infinite;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        /* Order Status Progress */
        .order-status-progress {
            margin-top: 16px;
            padding: 16px;
            background: #f3f4f6;
            border-radius: 12px;
        }

        .status-step {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
        }

        .status-step.active {
            background: #dbeafe;
            font-weight: 700;
        }

        .status-step.completed {
            background: #d1fae5;
        }

        .status-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .status-icon.active {
            background: #3b82f6;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-icon.completed {
            background: #22c55e;
            color: white;
        }

        .status-icon.pending {
            background: #e5e7eb;
            color: #9ca3af;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Delivery Boy Info Card */
        .delivery-info-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .delivery-info-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .delivery-info-card p {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .delivery-info-card a {
            color: white;
            text-decoration: underline;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #22c55e;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="logo">
                <div class="logo-icon">üçî</div>
                <h1>FoodExpress</h1>
                <p>Narsinghpur's #1 Food Delivery</p>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchLoginTab('login')">Login</button>
                <button class="tab-btn" onclick="switchLoginTab('register')">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-input">
                        <input type="password" id="loginPassword" placeholder="Enter password">
                        <button class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
                    </div>
                </div>
                <button class="btn-primary" onclick="handleLogin()">Login</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>Role</label>
                    <select id="registerRole" onchange="handleRoleChange()">
                        <option value="user">User</option>
                        <option value="restaurant">Restaurant/Hotel</option>
                        <option value="delivery">Delivery Boy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="registerUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="registerPhone" placeholder="Enter phone number">
                </div>
                <div id="restaurantFields" class="hidden">
                    <div class="form-group">
                        <label>Restaurant Name</label>
                        <input type="text" id="restaurantName" placeholder="Enter restaurant name">
                    </div>
                    <div class="form-group">
                        <label>Bank Account</label>
                        <input type="text" id="bankAccount" placeholder="Enter bank account number">
                    </div>
                    <div class="form-group">
                        <label>IFSC Code</label>
                        <input type="text" id="ifscCode" placeholder="Enter IFSC code">
                    </div>
                </div>
                <button class="btn-primary" onclick="handleRegister()">Register</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="header admin">
            <div class="header-content">
                <div>
                    <h1>Admin Dashboard</h1>
                    <p>Narsinghpur Food Delivery System</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-white" onclick="handleLogout()">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchAdminTab('pending')">Pending Approvals (<span id="pendingCount">0</span>)</button>
                <button class="tab" onclick="switchAdminTab('orders')">All Orders (<span id="ordersCount">0</span>)</button>
                <button class="tab" onclick="switchAdminTab('recharges')">Recharge History (<span id="rechargesCount">0</span>)</button>
                <button class="tab" onclick="switchAdminTab('payment')">Payment Settings</button>
                <button class="tab" onclick="switchAdminTab('users')">All Users (<span id="usersCount">0</span>)</button>
            </div>

            <div id="adminPending">
                <div class="card">
                    <h2>Pending Restaurant Approvals</h2>
                    <div id="pendingRestaurants"></div>
                </div>
                <div class="card">
                    <h2>Pending Delivery Boy Approvals</h2>
                    <div id="pendingDelivery"></div>
                </div>
            </div>

            <div id="adminOrders" class="hidden">
                <div class="card">
                    <h2>All Orders</h2>
                    <div id="allOrdersList"></div>
                </div>
            </div>

            <div id="adminRecharges" class="hidden">
                <div class="card">
                    <h2>Delivery Boy Recharge History</h2>
                    <div id="rechargeHistoryList"></div>
                </div>
            </div>

            <div id="adminPayment" class="hidden">
                <div class="card">
                    <h2>Payment Settings</h2>
                    <div class="form-group">
                        <label>UPI ID</label>
                        <input type="text" id="adminUpiId" placeholder="merchant@upi">
                    </div>
                    <div class="form-group">
                        <label>QR Code Image URL</label>
                        <input type="text" id="adminQrCode" placeholder="Enter image URL or base64">
                    </div>
                    <div id="qrPreview"></div>
                    <button class="btn-primary" onclick="savePaymentSettings()">Save Settings</button>
                </div>
            </div>

            <div id="adminUsers" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>All Users</h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 12px 20px; border-radius: 12px; border: 2px solid #3b82f6;">
                                <p style="font-size: 11px; color: #1e3a8a; font-weight: 700; margin-bottom: 4px;">üåê DATABASE STATUS</p>
                                <p style="font-size: 14px; font-weight: 700;" id="dbStatus">Connecting...</p>
                            </div>
                            <button onclick="saveToDatabase(); showNotification('Database saved manually!')" class="btn" style="background: #22c55e; color: white;">
                                üíæ Save Now
                            </button>
                            <button onclick="resetDatabase()" class="btn" style="background: #ef4444; color: white;">
                                üóëÔ∏è Reset All
                            </button>
                        </div>
                    </div>
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                        <p style="font-size: 13px; color: #92400e;"><strong>‚ö†Ô∏è Important:</strong> All data is stored in Firebase Cloud Database. Changes made by anyone will sync to all devices in real-time.</p>
                    </div>
                    <div id="allUsersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Restaurant Panel -->
    <div id="restaurantPanel" class="hidden">
        <div class="header restaurant">
            <div class="header-content">
                <div>
                    <h1 id="restaurantName"></h1>
                    <p>Restaurant Management Panel</p>
                </div>
                <div class="header-actions">
                    <button class="btn" id="toggleRestaurantBtn" onclick="toggleRestaurant()">
                        üü¢ Open
                    </button>
                    <button class="btn btn-white" onclick="handleLogout()">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="grid-2">
                <div class="card">
                    <h2>Add Menu Item</h2>
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="itemName" placeholder="e.g., Butter Chicken">
                    </div>
                    <div class="form-group">
                        <label>Price (‚Çπ)</label>
                        <input type="number" id="itemPrice" placeholder="e.g., 250">
                    </div>
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" id="itemImage" placeholder="https://example.com/image.jpg">
                    </div>
                    <button class="btn-primary" onclick="addMenuItem()">‚ûï Add Item</button>
                </div>

                <div class="card">
                    <h2>Your Menu (<span id="menuCount">0</span>)</h2>
                    <div id="restaurantMenu" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <div class="card">
                <h2>Restaurant Location</h2>
                <p style="color: #6b7280; margin-bottom: 16px;">Set your restaurant location for delivery boy navigation</p>
                <div class="form-group">
                    <label>Latitude</label>
                    <input type="number" step="0.0001" id="restaurantLat" placeholder="e.g., 22.9167">
                </div>
                <div class="form-group">
                    <label>Longitude</label>
                    <input type="number" step="0.0001" id="restaurantLng" placeholder="e.g., 79.2000">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-primary" style="flex: 1;" onclick="updateRestaurantLocation()">Update Location</button>
                    <button class="btn-map" onclick="openMapSelector('restaurant')">üó∫Ô∏è Select on Map</button>
                </div>
                <div id="currentLocation" style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px;"></div>
            </div>

            <div class="card">
                <h2>Incoming Orders (<span id="incomingOrdersCount">0</span>)</h2>
                <div id="incomingOrders"></div>
            </div>

            <div class="card">
                <h2>All Orders History</h2>
                <div id="restaurantOrderHistory"></div>
            </div>
        </div>
    </div>

    <!-- Delivery Panel -->
    <div id="deliveryPanel" class="hidden">
        <div class="header delivery">
            <div class="header-content">
                <div>
                    <h1>Delivery Panel</h1>
                    <p id="deliveryBoyName"></p>
                    <p id="deliveryWallet" style="font-weight: 700;"></p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-white" onclick="handleLogout()">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="card">
                <h2>My Deliveries (<span id="activeDeliveriesCount">0</span>)</h2>
                <div id="activeDeliveries"></div>
            </div>

            <div class="card">
                <h2>üìä Earnings Summary</h2>
                <div id="earningSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;"></div>
            </div>

            <div class="card">
                <h2>Completed Deliveries</h2>
                <div id="completedDeliveries"></div>
            </div>

            <div class="card">
                <h2>Recharge Wallet</h2>
                <p style="margin-bottom: 16px; color: #6b7280;">Current Balance: <span style="font-weight: 700; color: #059669;">‚Çπ<span id="walletBalance">0</span></span></p>
                <div class="form-group">
                    <label>Recharge Amount (‚Çπ)</label>
                    <input type="number" id="rechargeAmount" placeholder="Enter amount">
                </div>
                <button class="btn-primary" onclick="openRechargeModal()">Recharge Now</button>
            </div>
        </div>
    </div>

    <!-- Recharge Modal -->
    <div id="rechargeModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 400px; width: 90%;">
            <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 20px;">Complete Payment</h2>
            <p style="margin-bottom: 16px;">Amount: <span style="font-weight: 700; font-size: 24px; color: #059669;">‚Çπ<span id="rechargeDisplayAmount">0</span></span></p>
            
            <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                <p style="font-weight: 700; margin-bottom: 8px;">UPI ID:</p>
                <p style="font-size: 14px; color: #4b5563;" id="rechargeUpiId"></p>
            </div>
            
            <div style="text-align: center; margin-bottom: 16px;">
                <p style="font-weight: 700; margin-bottom: 8px;">Scan QR Code:</p>
                <img id="rechargeQrCode" src="" style="width: 200px; height: 200px; border: 2px solid #e5e7eb; border-radius: 12px;">
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn" style="flex: 1; background: #e5e7eb; color: #1f2937;" onclick="closeRechargeModal()">Cancel</button>
                <button class="btn-primary" style="flex: 1;" onclick="confirmRecharge()">Payment Done</button>
            </div>
        </div>
    </div>

    <!-- User Panel -->
    <div id="userPanel" class="hidden">
        <div class="header user">
            <div class="header-content">
                <div>
                    <h1>FoodExpress</h1>
                    <p>Narsinghpur, Madhya Pradesh</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-white" onclick="shareApp()">
                        üì§ Share & Earn ‚Çπ50
                    </button>
                    <button class="btn btn-yellow" id="cartBtn" onclick="viewCart()" style="display: none;">
                        üõí Cart (<span id="cartCount">0</span>)
                    </button>
                    <button class="btn btn-white" onclick="handleLogout()">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div id="userRestaurantsList">
                <h2 style="font-size: 28px; font-weight: 900; margin-bottom: 24px;">Open Restaurants (<span id="openRestaurantsCount">0</span>)</h2>
                <div id="restaurantsList" class="grid"></div>

                <h2 style="font-size: 28px; font-weight: 900; margin-bottom: 24px; margin-top: 48px;">My Orders (<span id="myOrdersCount">0</span>)</h2>
                <div id="myOrdersList"></div>
            </div>

            <div id="userRestaurantMenu" class="hidden">
                <button class="btn" onclick="backToRestaurants()" style="margin-bottom: 20px;">‚Üê Back to Restaurants</button>
                <h2 style="font-size: 28px; font-weight: 900; margin-bottom: 24px;" id="selectedRestaurantName"></h2>
                <div id="menuItemsList" class="grid"></div>
            </div>

            <div id="userCart" class="hidden">
                <button class="btn" onclick="backToMenu()" style="margin-bottom: 20px;">‚Üê Back</button>
                <h2 style="font-size: 28px; font-weight: 900; margin-bottom: 24px;">Your Cart</h2>
                
                <div style="max-width: 800px; margin: 0 auto;">
                    <div class="card">
                        <h2>Delivery Location</h2>
                        <div class="form-group">
                            <label>Latitude</label>
                            <input type="number" step="0.0001" id="userLat" placeholder="e.g., 22.9167">
                        </div>
                        <div class="form-group">
                            <label>Longitude</label>
                            <input type="number" step="0.0001" id="userLng" placeholder="e.g., 79.2000">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" style="background: #3b82f6; color: white; flex: 1;" onclick="updateUserLocation()">Set Location</button>
                            <button class="btn-map" onclick="openMapSelector('user')">üó∫Ô∏è Select on Map</button>
                        </div>
                        <div id="userCurrentLocation" style="margin-top: 12px; padding: 12px; background: #f3f4f6; border-radius: 8px;"></div>
                    </div>

                    <div class="card">
                        <h2>Cart Items</h2>
                        <div id="cartItems"></div>
                    </div>

                    <div class="card">
                        <h2>Apply Coupon</h2>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="couponInput" placeholder="Enter coupon code" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px;">
                            <button class="btn" style="background: #f97316; color: white;" onclick="applyCoupon()">Apply</button>
                        </div>
                        <div id="couponMessage" style="margin-top: 12px;"></div>
                    </div>

                    <div class="card">
                        <h2>Bill Summary</h2>
                        <div id="billSummary"></div>
                    </div>

                    <div class="card">
                        <h2>Payment Method</h2>
                        <div class="payment-grid">
                            <button class="payment-btn cod" onclick="placeOrder('cod')">
                                üíµ Cash on Delivery
                            </button>
                            <button class="payment-btn online" onclick="placeOrder('online')">
                                üí≥ Pay Online
                            </button>
                        </div>
                        <div id="paymentQr" class="qr-display"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="hidden map-modal">

    <!-- Alarm Audio -->
    <audio id="alarmSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKXh8bllHAU2kdfy0HovBSN1xe/glEILElyx6OyrWBUIQ5zd8sFuJAUrgc7y2Ik2CBtpvfDknE4MDlCl4fG5ZRwFNpHX8tB6LwUjdcXv4JRCCxJcsejsq1gVCEOc3fLBbiQFK4HO8tmJNggbab3w5JxODA5QpeHxuWUcBTaR1/LQei8FI3XF7+CUQgsR" type="audio/wav">
    </audio>

    <!-- Payment Confirmation Modal -->
    <div id="paymentModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1500;">
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;">üí≥</div>
            <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 16px;">Complete Online Payment</h2>
            <p style="margin-bottom: 24px; color: #6b7280;">Amount to Pay: <span style="font-weight: 700; font-size: 28px; color: #059669;">‚Çπ<span id="paymentAmount">0</span></span></p>
            
            <div style="background: #f3f4f6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <p style="font-weight: 700; margin-bottom: 12px;">UPI ID:</p>
                <p style="font-size: 18px; color: #4b5563; margin-bottom: 16px;" id="paymentUpiId"></p>
                
                <p style="font-weight: 700; margin-bottom: 12px;">Scan QR Code:</p>
                <img id="paymentQrCode" src="" style="width: 250px; height: 250px; border: 2px solid #e5e7eb; border-radius: 12px; margin: 0 auto;">
            </div>
            
            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                <p style="font-size: 13px; color: #92400e; font-weight: 700;">‚ö†Ô∏è Complete payment before proceeding</p>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn" style="flex: 1; background: #e5e7eb; color: #1f2937;" onclick="cancelPayment()">Cancel Order</button>
                <button class="btn-primary" style="flex: 1;" onclick="confirmOnlinePayment()">‚úì Payment Done</button>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="hidden map-modal">
        <div class="map-container">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                <h2 style="font-size: 24px; font-weight: 900;">Select Location on Map</h2>
                <button onclick="closeMapModal()" style="background: #e5e7eb; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-left: auto;">‚úï Close</button>
            </div>
            
            <p style="color: #6b7280; margin-bottom: 16px;">Click anywhere on the map to select your location</p>
            
            <div id="mapCanvas" class="map-canvas" onclick="handleMapClick(event)">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 8px;">üó∫Ô∏è</div>
                    <p style="font-weight: 700;">Narsinghpur Map</p>
                    <p style="font-size: 14px;">Click to select location</p>
                </div>
                <div id="mapMarker" class="map-marker hidden"></div>
            </div>
            
            <div class="map-info">
                <p style="font-weight: 700; margin-bottom: 8px;">Selected Location:</p>
                <p style="font-size: 14px; color: #4b5563;">Latitude: <span id="selectedLat">-</span></p>
                <p style="font-size: 14px; color: #4b5563;">Longitude: <span id="selectedLng">-</span></p>
            </div>
            
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button class="btn" style="flex: 1; background: #e5e7eb; color: #1f2937;" onclick="closeMapModal()">Cancel</button>
                <button class="btn-primary" style="flex: 1;" onclick="confirmMapLocation()">Confirm Location</button>
            </div>
        </div>
    </div>

    <!-- Order Map View Modal -->
    <div id="orderMapModal" class="hidden map-modal">
        <div class="map-container">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 16px;">
                <h2 style="font-size: 24px; font-weight: 900;">Order Route Map</h2>
                <button onclick="closeOrderMapModal()" style="background: #e5e7eb; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-left: auto;">‚úï Close</button>
            </div>
            
            <div id="orderMapCanvas" class="map-canvas" style="height: 500px; position: relative;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #9ca3af;">
                    <div style="font-size: 48px; margin-bottom: 8px;">üó∫Ô∏è</div>
                    <p style="font-weight: 700;">Narsinghpur Map</p>
                </div>
                <div id="restaurantMarker" style="position: absolute; width: 30px; height: 30px; background: #22c55e; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none;">
                    <span style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; white-space: nowrap; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">Restaurant</span>
                </div>
                <div id="customerMarker" style="position: absolute; width: 30px; height: 30px; background: #ef4444; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none;">
                    <span style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; white-space: nowrap; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">Customer</span>
                </div>
                <svg id="routeLine" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>
            </div>
            
            <div class="map-info">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <p style="font-weight: 700; margin-bottom: 4px;">üè™ Restaurant Location:</p>
                        <p style="font-size: 14px; color: #4b5563;" id="orderRestaurantLoc">-</p>
                    </div>
                    <div>
                        <p style="font-weight: 700; margin-bottom: 4px;">üè† Customer Location:</p>
                        <p style="font-size: 14px; color: #4b5563;" id="orderCustomerLoc">-</p>
                    </div>
                </div>
                <p style="font-weight: 700; margin-top: 12px; color: #059669;">Distance: <span id="orderDistance">-</span> km</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ========== FIREBASE CONFIGURATION ==========
        // IMPORTANT: Replace these with your own Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBKzyXLOmS5F38slF6Wi1Wqt4QwVeG8nWU",
    authDomain: "online-food-order-e6660.firebaseapp.com",
    databaseURL: "https://online-food-order-e6660-default-rtdb.firebaseio.com",
    projectId: "online-food-order-e6660",
    storageBucket: "online-food-order-e6660.firebasestorage.app",
    messagingSenderId: "614177218918",
    appId: "1:614177218918:web:859388ec76cda63b15e8a7",
    measurementId: "G-G1155D9F1F"
  };

        // Initialize Firebase
        let database;
        let isFirebaseConnected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            isFirebaseConnected = true;
            console.log('‚úÖ Firebase Connected Successfully!');
        } catch (error) {
            console.error('‚ùå Firebase Connection Failed:', error);
            console.log('üìù Using LocalStorage as fallback');
        }

        // ========== DATABASE FUNCTIONS (Firebase + LocalStorage Fallback) ==========
        const DB_KEY = 'foodExpress_database';
        const DB_PATH = 'foodExpress/data';
        
        function saveToDatabase() {
            const dbData = {
                users: appData.users,
                restaurants: appData.restaurants,
                menuItems: appData.menuItems,
                orders: appData.orders,
                deliveryBoys: appData.deliveryBoys,
                rechargeHistory: appData.rechargeHistory,
                coupons: appData.coupons,
                paymentSettings: appData.paymentSettings,
                lastUpdated: new Date().toISOString()
            };

            if (isFirebaseConnected) {
                // Save to Firebase
                database.ref(DB_PATH).set(dbData)
                    .then(() => {
                        console.log('‚úÖ Data saved to Firebase (Cloud)');
                        updateDatabaseStatus('Connected - Cloud Sync Active');
                    })
                    .catch((error) => {
                        console.error('‚ùå Firebase save error:', error);
                        // Fallback to localStorage
                        saveToLocalStorage(dbData);
                    });
            } else {
                // Fallback to localStorage
                saveToLocalStorage(dbData);
            }
        }

        function saveToLocalStorage(dbData) {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(dbData));
                console.log('‚úÖ Data saved to LocalStorage (Offline)');
                updateDatabaseStatus('Offline Mode');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        function loadFromDatabase() {
            return new Promise((resolve) => {
                if (isFirebaseConnected) {
                    // Load from Firebase
                    database.ref(DB_PATH).once('value')
                        .then((snapshot) => {
                            const dbData = snapshot.val();
                            if (dbData) {
                                applyDatabaseData(dbData);
                                console.log('‚úÖ Data loaded from Firebase (Cloud)');
                                console.log('Last updated:', dbData.lastUpdated);
                                updateDatabaseStatus('Connected - Cloud Sync Active');
                                
                                // Setup real-time listener for live updates
                                setupRealtimeListener();
                                resolve(true);
                            } else {
                                console.log('üì¶ No data in Firebase yet');
                                resolve(false);
                            }
                        })
                        .catch((error) => {
                            console.error('‚ùå Firebase load error:', error);
                            // Fallback to localStorage
                            resolve(loadFromLocalStorage());
                        });
                } else {
                    // Fallback to localStorage
                    resolve(loadFromLocalStorage());
                }
            });
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(DB_KEY);
                if (savedData) {
                    const dbData = JSON.parse(savedData);
                    applyDatabaseData(dbData);
                    console.log('‚úÖ Data loaded from LocalStorage (Offline)');
                    updateDatabaseStatus('Offline Mode');
                    return true;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
            return false;
        }

        function applyDatabaseData(dbData) {
            appData.users = dbData.users || appData.users;
            appData.restaurants = dbData.restaurants || [];
            appData.menuItems = dbData.menuItems || [];
            appData.orders = dbData.orders || [];
            appData.deliveryBoys = dbData.deliveryBoys || [];
            appData.rechargeHistory = dbData.rechargeHistory || [];
            appData.coupons = dbData.coupons || appData.coupons;
            appData.paymentSettings = dbData.paymentSettings || appData.paymentSettings;
        }

        function setupRealtimeListener() {
            if (!isFirebaseConnected) return;

            database.ref(DB_PATH).on('value', (snapshot) => {
                const dbData = snapshot.val();
                if (dbData && appData.currentUser) {
                    // Only update if user is logged in and data is newer
                    const currentTime = new Date(appData.lastUpdated || 0).getTime();
                    const newTime = new Date(dbData.lastUpdated || 0).getTime();
                    
                    if (newTime > currentTime) {
                        console.log('üîÑ Real-time update received from cloud');
                        applyDatabaseData(dbData);
                        appData.lastUpdated = dbData.lastUpdated;
                        
                        // Refresh current panel
                        refreshCurrentPanel();
                    }
                }
            });
        }

        function refreshCurrentPanel() {
            if (!appData.currentUser) return;

            if (appData.currentUser.role === 'admin') {
                renderPendingApprovals();
                renderAllOrders();
                renderRechargeHistory();
                renderAllUsers();
                updateAdminCounts();
            } else if (appData.currentUser.role === 'restaurant') {
                renderRestaurantPanel();
            } else if (appData.currentUser.role === 'delivery') {
                renderDeliveryPanel();
            } else if (appData.currentUser.role === 'user') {
                renderRestaurantsList();
                renderMyOrders();
            }
        }

        function updateDatabaseStatus(status) {
            const statusElement = document.getElementById('dbStatus');
            if (statusElement) {
                statusElement.textContent = status;
                
                if (status.includes('Cloud')) {
                    statusElement.style.color = '#059669';
                } else {
                    statusElement.style.color = '#f59e0b';
                }
            }
        }
        
        function resetDatabase() {
            if (confirm('‚ö†Ô∏è Are you sure you want to reset all data? This will affect ALL USERS and cannot be undone!')) {
                if (isFirebaseConnected) {
                    database.ref(DB_PATH).remove()
                        .then(() => {
                            localStorage.removeItem(DB_KEY);
                            alert('Database reset successfully! Page will reload.');
                            location.reload();
                        })
                        .catch((error) => {
                            console.error('Error resetting Firebase:', error);
                        });
                } else {
                    localStorage.removeItem(DB_KEY);
                    location.reload();
                }
            }
        }
        
        // Auto-save function - saves data every time there's a change
        function autoSave() {
            appData.lastUpdated = new Date().toISOString();
            saveToDatabase();
        }

        // ========== DATA STORAGE ==========
        let appData = {
            users: [
                { id: 1, username: 'admin', password: 'admin123', role: 'admin', phone: '9876543210', approved: true }
            ],
            restaurants: [],
            menuItems: [],
            orders: [],
            deliveryBoys: [],
            rechargeHistory: [],
            coupons: [
                { code: 'FIRST50', discount: 50, minOrder: 200 },
                { code: 'SAVE100', discount: 100, minOrder: 500 }
            ],
            paymentSettings: {
                upiId: 'merchant@upi',
                qrCode: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0id2hpdGUiLz48cmVjdCB4PSI0MCIgeT0iNDAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0iYmxhY2siLz48cmVjdCB4PSI4MCIgeT0iNDAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0iYmxhY2siLz48cmVjdCB4PSIxNDAiIHk9IjQwIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIGZpbGw9ImJsYWNrIi8+PC9zdmc+'
            },
            cart: [],
            selectedCoupon: null,
            currentUser: null,
            selectedRestaurant: null,
            userLocation: null,
            mapSelector: { type: null, callback: null },
            lastOrderCount: { admin: 0, restaurant: {}, delivery: {} },
            alarmInterval: null,
            pendingPayment: null,
            lastUpdated: null
        };

        const narsinghpurCenter = { lat: 22.9167, lng: 79.2000 };

        // ========== UTILITY FUNCTIONS ==========
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function playAlarm() {
            const audio = document.getElementById('alarmSound');
            if (audio) {
                // Create beep pattern for 40 seconds
                let playCount = 0;
                const maxPlays = 40; // 40 seconds
                
                appData.alarmInterval = setInterval(() => {
                    if (playCount >= maxPlays) {
                        clearInterval(appData.alarmInterval);
                        return;
                    }
                    
                    // Play beep sound
                    const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUKXh8bllHAU2kdfy0HovBSN1xe/glEILElyx6OyrWBUIQ5zd8sFuJAUrgc7y2Ik2CBtpvfDknE4MDlCl4fG5ZRwFNpHX8tB6LwUjdcXv4JRCCxJcsejsq1gVCEOc3fLBbiQFK4HO8tmJNggbab3w5JxODA5QpeHxuWUcBTaR1/LQei8FI3XF7+CUQgsR');
                    beep.play().catch(e => console.log('Audio play failed:', e));
                    
                    playCount++;
                }, 1000); // Every 1 second
                
                // Show alarm notification
                const alarmNotif = document.createElement('div');
                alarmNotif.className = 'notification alarm-notification';
                alarmNotif.innerHTML = 'üîî New Order Received! <button onclick="stopAlarm()" style="margin-left: 12px; background: white; border: none; padding: 4px 12px; border-radius: 6px; font-weight: 700; cursor: pointer;">Stop Alarm</button>';
                document.body.appendChild(alarmNotif);
                setTimeout(() => alarmNotif.remove(), 41000);
            }
        }

        function stopAlarm() {
            if (appData.alarmInterval) {
                clearInterval(appData.alarmInterval);
                appData.alarmInterval = null;
            }
        }

        function hideAllPanels() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('restaurantPanel').classList.add('hidden');
            document.getElementById('deliveryPanel').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
        }

        // ========== LOGIN/REGISTER ==========
        function switchLoginTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabs[1].classList.add('active');
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function handleRoleChange() {
            const role = document.getElementById('registerRole').value;
            const restaurantFields = document.getElementById('restaurantFields');
            
            if (role === 'restaurant') {
                restaurantFields.classList.remove('hidden');
            } else {
                restaurantFields.classList.add('hidden');
            }
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                appData.currentUser = user;
                hideAllPanels();
                
                if (user.role === 'admin') {
                    showAdminPanel();
                } else if (user.role === 'restaurant') {
                    showRestaurantPanel();
                } else if (user.role === 'delivery') {
                    showDeliveryPanel();
                } else {
                    showUserPanel();
                }
            } else {
                showNotification('Invalid credentials!', 'error');
            }
        }

        function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const phone = document.getElementById('registerPhone').value;
            const role = document.getElementById('registerRole').value;
            
            if (!username || !password) {
                showNotification('Username and password required!', 'error');
                return;
            }
            
            const newUser = {
                id: appData.users.length + 1,
                username,
                password,
                role,
                phone,
                approved: role === 'user',
                wallet: 0
            };
            
            if (role === 'restaurant') {
                const restaurantName = document.getElementById('restaurantName').value;
                const bankAccount = document.getElementById('bankAccount').value;
                const ifscCode = document.getElementById('ifscCode').value;
                
                const newRestaurant = {
                    id: appData.restaurants.length + 1,
                    userId: newUser.id,
                    name: restaurantName,
                    bankAccount,
                    ifsc: ifscCode,
                    isOpen: true,
                    location: {
                        lat: narsinghpurCenter.lat + (Math.random() - 0.5) * 0.05,
                        lng: narsinghpurCenter.lng + (Math.random() - 0.5) * 0.05
                    }
                };
                appData.restaurants.push(newRestaurant);
                newUser.restaurantId = newRestaurant.id;
                newUser.approved = false;
            }
            
            if (role === 'delivery') {
                const newDeliveryBoy = {
                    id: appData.deliveryBoys.length + 1,
                    userId: newUser.id,
                    name: username,
                    wallet: 0,
                    location: { lat: narsinghpurCenter.lat, lng: narsinghpurCenter.lng }
                };
                appData.deliveryBoys.push(newDeliveryBoy);
                newUser.deliveryBoyId = newDeliveryBoy.id;
                newUser.approved = false;
            }
            
            appData.users.push(newUser);
            autoSave(); // Save to database
            showNotification(`Registration successful! ${role === 'user' ? 'You can login now.' : 'Wait for admin approval.'}`);
            
            // Clear form
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPhone').value = '';
            switchLoginTab('login');
        }

        function handleLogout() {
            appData.currentUser = null;
            appData.cart = [];
            appData.selectedCoupon = null;
            appData.selectedRestaurant = null;
            hideAllPanels();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // ========== ADMIN PANEL ==========
        function showAdminPanel() {
            document.getElementById('adminPanel').classList.remove('hidden');
            switchAdminTab('pending');
            startOrderMonitoring();
        }

        function startOrderMonitoring() {
            // Check for new orders every 2 seconds
            setInterval(() => {
                if (!appData.currentUser) return;
                
                if (appData.currentUser.role === 'admin') {
                    const currentOrders = appData.orders.length;
                    if (currentOrders > appData.lastOrderCount.admin) {
                        playAlarm();
                        appData.lastOrderCount.admin = currentOrders;
                    }
                } else if (appData.currentUser.role === 'restaurant') {
                    const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
                    if (restaurant) {
                        const pendingOrders = appData.orders.filter(o => o.restaurantId === restaurant.id && o.status === 'pending').length;
                        const lastCount = appData.lastOrderCount.restaurant[restaurant.id] || 0;
                        if (pendingOrders > lastCount) {
                            playAlarm();
                            appData.lastOrderCount.restaurant[restaurant.id] = pendingOrders;
                        }
                    }
                } else if (appData.currentUser.role === 'delivery') {
                    const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
                    if (deliveryBoy) {
                        const assignedOrders = appData.orders.filter(o => o.deliveryBoyId === deliveryBoy.id && o.status === 'assigned').length;
                        const lastCount = appData.lastOrderCount.delivery[deliveryBoy.id] || 0;
                        if (assignedOrders > lastCount) {
                            playAlarm();
                            appData.lastOrderCount.delivery[deliveryBoy.id] = assignedOrders;
                        }
                    }
                }
            }, 2000);
        }

        function switchAdminTab(tab) {
            const tabs = document.querySelectorAll('#adminPanel .tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            document.getElementById('adminPending').classList.add('hidden');
            document.getElementById('adminOrders').classList.add('hidden');
            document.getElementById('adminRecharges').classList.add('hidden');
            document.getElementById('adminPayment').classList.add('hidden');
            document.getElementById('adminUsers').classList.add('hidden');
            
            if (tab === 'pending') {
                tabs[0].classList.add('active');
                document.getElementById('adminPending').classList.remove('hidden');
                renderPendingApprovals();
            } else if (tab === 'orders') {
                tabs[1].classList.add('active');
                document.getElementById('adminOrders').classList.remove('hidden');
                renderAllOrders();
            } else if (tab === 'recharges') {
                tabs[2].classList.add('active');
                document.getElementById('adminRecharges').classList.remove('hidden');
                renderRechargeHistory();
            } else if (tab === 'payment') {
                tabs[3].classList.add('active');
                document.getElementById('adminPayment').classList.remove('hidden');
                renderPaymentSettings();
            } else if (tab === 'users') {
                tabs[4].classList.add('active');
                document.getElementById('adminUsers').classList.remove('hidden');
                renderAllUsers();
            }
            
            updateAdminCounts();
        }

        function updateAdminCounts() {
            const pendingCount = appData.users.filter(u => !u.approved && u.role !== 'admin').length;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('ordersCount').textContent = appData.orders.length;
            document.getElementById('rechargesCount').textContent = appData.rechargeHistory.length;
            document.getElementById('usersCount').textContent = appData.users.length;
        }

        function renderPendingApprovals() {
            const pendingRestaurants = appData.users.filter(u => u.role === 'restaurant' && !u.approved);
            const pendingDelivery = appData.users.filter(u => u.role === 'delivery' && !u.approved);
            
            let restaurantsHtml = '';
            if (pendingRestaurants.length === 0) {
                restaurantsHtml = '<p class="empty-state">No pending restaurant approvals</p>';
            } else {
                pendingRestaurants.forEach(user => {
                    const restaurant = appData.restaurants.find(r => r.userId === user.id);
                    restaurantsHtml += `
                        <div class="approval-card">
                            <div class="approval-info">
                                <h3>${restaurant?.name}</h3>
                                <p>Username: ${user.username}</p>
                                <p>Phone: ${user.phone}</p>
                                <p>Bank: ${restaurant?.bankAccount} | IFSC: ${restaurant?.ifsc}</p>
                            </div>
                            <div class="approval-actions">
                                <button class="btn-icon btn-approve" onclick="approveUser(${user.id})">‚úì</button>
                                <button class="btn-icon btn-reject" onclick="rejectUser(${user.id})">‚úï</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('pendingRestaurants').innerHTML = restaurantsHtml;
            
            let deliveryHtml = '';
            if (pendingDelivery.length === 0) {
                deliveryHtml = '<p class="empty-state">No pending delivery approvals</p>';
            } else {
                pendingDelivery.forEach(user => {
                    deliveryHtml += `
                        <div class="approval-card">
                            <div class="approval-info">
                                <h3>${user.username}</h3>
                                <p>Phone: ${user.phone}</p>
                            </div>
                            <div class="approval-actions">
                                <button class="btn-icon btn-approve" onclick="approveUser(${user.id})">‚úì</button>
                                <button class="btn-icon btn-reject" onclick="rejectUser(${user.id})">‚úï</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('pendingDelivery').innerHTML = deliveryHtml;
        }

        function approveUser(userId) {
            const user = appData.users.find(u => u.id === userId);
            if (user) {
                user.approved = true;
                autoSave(); // Save to database
                showNotification(`${user.username} approved successfully!`);
                renderPendingApprovals();
                updateAdminCounts();
            }
        }

        function rejectUser(userId) {
            appData.users = appData.users.filter(u => u.id !== userId);
            autoSave(); // Save to database
            showNotification('User rejected and removed');
            renderPendingApprovals();
            updateAdminCounts();
        }

        function renderAllOrders() {
            let html = '';
            if (appData.orders.length === 0) {
                html = '<p class="empty-state"><div class="empty-state-icon">üì¶</div>No orders yet</p>';
            } else {
                appData.orders.forEach(order => {
                    const restaurant = appData.restaurants.find(r => r.id === order.restaurantId);
                    const user = appData.users.find(u => u.id === order.userId);
                    const deliveryBoy = appData.deliveryBoys.find(d => d.id === order.deliveryBoyId);
                    
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-info">
                                    <h3>Order #${order.id}</h3>
                                    <p>Restaurant: ${restaurant?.name}</p>
                                    <p>Customer: ${user?.username} | ${user?.phone}</p>
                                    <p>Amount: ‚Çπ${order.total}</p>
                                    ${deliveryBoy ? `<p>Delivery Boy: ${deliveryBoy.name}</p>` : ''}
                                </div>
                                <span class="badge badge-${order.status}">${order.status}</span>
                            </div>
                            ${order.status === 'accepted' && !order.deliveryBoyId ? `
                                <div style="margin-top: 12px;">
                                    <label style="display: block; font-weight: 700; margin-bottom: 8px;">Assign Delivery Boy:</label>
                                    <select onchange="assignDelivery(${order.id}, this.value)" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select delivery boy</option>
                                        ${appData.deliveryBoys.filter(db => appData.users.find(u => u.id === db.userId)?.approved).map(db => 
                                            `<option value="${db.id}">${db.name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            document.getElementById('allOrdersList').innerHTML = html;
        }

        function assignDelivery(orderId, deliveryBoyId) {
            if (!deliveryBoyId) return;
            
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.deliveryBoyId = parseInt(deliveryBoyId);
                order.status = 'assigned';
                autoSave(); // Save to database
                showNotification('Delivery boy assigned successfully!');
                renderAllOrders();
            }
        }

        function renderRechargeHistory() {
            let html = '';
            if (appData.rechargeHistory.length === 0) {
                html = '<p class="empty-state"><div class="empty-state-icon">üí≥</div>No recharge history yet</p>';
            } else {
                appData.rechargeHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(recharge => {
                    const deliveryBoy = appData.deliveryBoys.find(d => d.id === recharge.deliveryBoyId);
                    const date = new Date(recharge.timestamp);
                    html += `
                        <div class="order-card">
                            <div style="display: flex; justify-between; align-items: center;">
                                <div>
                                    <h3 style="font-weight: 700; font-size: 18px;">${deliveryBoy?.name}</h3>
                                    <p style="font-size: 14px; color: #6b7280;">Amount: ‚Çπ${recharge.amount}</p>
                                    <p style="font-size: 14px; color: #6b7280;">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</p>
                                </div>
                                <span class="badge badge-delivered">Completed</span>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('rechargeHistoryList').innerHTML = html;
        }

        function renderPaymentSettings() {
            document.getElementById('adminUpiId').value = appData.paymentSettings.upiId;
            document.getElementById('adminQrCode').value = appData.paymentSettings.qrCode;
            
            if (appData.paymentSettings.qrCode) {
                document.getElementById('qrPreview').innerHTML = `
                    <div style="margin-top: 16px;">
                        <p style="font-weight: 700; margin-bottom: 8px;">Preview:</p>
                        <img src="${appData.paymentSettings.qrCode}" style="width: 200px; height: 200px; border: 2px solid #e5e7eb; border-radius: 12px;">
                    </div>
                `;
            }
        }

        function savePaymentSettings() {
            appData.paymentSettings.upiId = document.getElementById('adminUpiId').value;
            appData.paymentSettings.qrCode = document.getElementById('adminQrCode').value;
            autoSave(); // Save to database
            showNotification('Payment settings saved successfully!');
            renderPaymentSettings();
        }

        function renderAllUsers() {
            let html = '';
            appData.users.forEach(user => {
                html += `
                    <div class="approval-card">
                        <div class="approval-info">
                            <h3>${user.username}</h3>
                            <p>Role: ${user.role}</p>
                            <p>Phone: ${user.phone}</p>
                            ${user.wallet !== undefined ? `<p>Wallet: ‚Çπ${user.wallet}</p>` : ''}
                        </div>
                        <span class="badge ${user.approved ? 'badge-open' : 'badge-pending'}">
                            ${user.approved ? 'Approved' : 'Pending'}
                        </span>
                    </div>
                `;
            });
            document.getElementById('allUsersList').innerHTML = html;
        }

        // ========== RESTAURANT PANEL ==========
        function showRestaurantPanel() {
            if (!appData.currentUser.approved) {
                showNotification('Your account is pending admin approval', 'error');
                handleLogout();
                return;
            }
            
            document.getElementById('restaurantPanel').classList.remove('hidden');
            renderRestaurantPanel();
            startOrderMonitoring();
        }

        function renderRestaurantPanel() {
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            document.querySelector('#restaurantPanel h1').textContent = restaurant?.name || 'Restaurant';
            
            const toggleBtn = document.getElementById('toggleRestaurantBtn');
            if (restaurant?.isOpen) {
                toggleBtn.textContent = 'üü¢ Open';
                toggleBtn.className = 'btn btn-green';
            } else {
                toggleBtn.textContent = 'üî¥ Closed';
                toggleBtn.className = 'btn btn-red';
            }
            
            // Update location fields
            if (restaurant?.location) {
                document.getElementById('restaurantLat').value = restaurant.location.lat;
                document.getElementById('restaurantLng').value = restaurant.location.lng;
                document.getElementById('currentLocation').innerHTML = `
                    <p style="font-weight: 700; margin-bottom: 4px;">Current Location:</p>
                    <p style="font-size: 14px; color: #4b5563;">Latitude: ${restaurant.location.lat.toFixed(4)}</p>
                    <p style="font-size: 14px; color: #4b5563;">Longitude: ${restaurant.location.lng.toFixed(4)}</p>
                `;
            }
            
            renderRestaurantMenu();
            renderIncomingOrders();
            renderRestaurantOrderHistory();
        }

        function updateRestaurantLocation() {
            const lat = parseFloat(document.getElementById('restaurantLat').value);
            const lng = parseFloat(document.getElementById('restaurantLng').value);
            
            if (!lat || !lng) {
                showNotification('Please enter valid latitude and longitude', 'error');
                return;
            }
            
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            if (restaurant) {
                restaurant.location = { lat, lng };
                autoSave(); // Save to database
                showNotification('Restaurant location updated successfully!');
                renderRestaurantPanel();
            }
        }

        function toggleRestaurant() {
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            if (restaurant) {
                restaurant.isOpen = !restaurant.isOpen;
                autoSave(); // Save to database
                renderRestaurantPanel();
                showNotification(`Restaurant is now ${restaurant.isOpen ? 'Open' : 'Closed'}`);
            }
        }

        function addMenuItem() {
            const name = document.getElementById('itemName').value;
            const price = document.getElementById('itemPrice').value;
            const image = document.getElementById('itemImage').value;
            
            if (!name || !price) {
                showNotification('Name and price required!', 'error');
                return;
            }
            
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            const newItem = {
                id: appData.menuItems.length + 1,
                restaurantId: restaurant.id,
                name,
                price: parseFloat(price),
                image: image || 'https://via.placeholder.com/150?text=Food'
            };
            
            appData.menuItems.push(newItem);
            autoSave(); // Save to database
            showNotification('Menu item added successfully!');
            
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemImage').value = '';
            
            renderRestaurantMenu();
        }

        function renderRestaurantMenu() {
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            const items = appData.menuItems.filter(item => item.restaurantId === restaurant?.id);
            
            document.getElementById('menuCount').textContent = items.length;
            
            let html = '';
            if (items.length === 0) {
                html = '<p class="empty-state">No menu items yet</p>';
            } else {
                items.forEach(item => {
                    html += `
                        <div class="menu-item-small">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="menu-item-info">
                                <h3>${item.name}</h3>
                                <p class="price">‚Çπ${item.price}</p>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('restaurantMenu').innerHTML = html;
        }

        function renderIncomingOrders() {
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            const orders = appData.orders.filter(o => o.restaurantId === restaurant?.id && o.status === 'pending');
            
            document.getElementById('incomingOrdersCount').textContent = orders.length;
            
            let html = '';
            if (orders.length === 0) {
                html = '<p class="empty-state"><div class="empty-state-icon">üì¶</div>No pending orders</p>';
            } else {
                orders.forEach(order => {
                    const user = appData.users.find(u => u.id === order.userId);
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-info">
                                    <h3>Order #${order.id}</h3>
                                    <p>Customer: ${user?.username} | ${user?.phone}</p>
                                    <p>Items: ${order.items.map(i => i.name).join(', ')}</p>
                                    <p class="price">Total: ‚Çπ${order.total}</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button class="btn btn-green" style="flex: 1;" onclick="acceptOrder(${order.id})">Accept Order</button>
                                <button class="btn btn-red" style="flex: 1;" onclick="rejectOrder(${order.id})">Reject</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('incomingOrders').innerHTML = html;
        }

        function acceptOrder(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'accepted';
                autoSave(); // Save to database
                showNotification('Order accepted!');
                renderIncomingOrders();
                renderRestaurantOrderHistory();
            }
        }

        function rejectOrder(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'rejected';
                autoSave(); // Save to database
                showNotification('Order rejected');
                renderIncomingOrders();
                renderRestaurantOrderHistory();
            }
        }

        function renderRestaurantOrderHistory() {
            const restaurant = appData.restaurants.find(r => r.userId === appData.currentUser.id);
            const orders = appData.orders.filter(o => o.restaurantId === restaurant?.id);
            
            let html = '';
            if (orders.length === 0) {
                html = '<p class="empty-state">No orders yet</p>';
            } else {
                orders.forEach(order => {
                    html += `
                        <div class="order-card">
                            <div style="display: flex; justify-between; align-items: center;">
                                <div>
                                    <h3>Order #${order.id}</h3>
                                    <p style="font-size: 14px; color: #6b7280;">‚Çπ${order.total}</p>
                                </div>
                                <span class="badge badge-${order.status}">${order.status}</span>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('restaurantOrderHistory').innerHTML = html;
        }

        // ========== DELIVERY PANEL ==========
        function showDeliveryPanel() {
            if (!appData.currentUser.approved) {
                showNotification('Your account is pending admin approval', 'error');
                handleLogout();
                return;
            }
            
            document.getElementById('deliveryPanel').classList.remove('hidden');
            renderDeliveryPanel();
            startOrderMonitoring();
        }

        function renderDeliveryPanel() {
            const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
            document.getElementById('deliveryBoyName').textContent = deliveryBoy?.name || '';
            document.getElementById('deliveryWallet').textContent = `Wallet: ‚Çπ${deliveryBoy?.wallet || 0}`;
            document.getElementById('walletBalance').textContent = deliveryBoy?.wallet || 0;
            
            renderActiveDeliveries();
            renderEarningSummary();
            renderCompletedDeliveries();
        }

        function renderEarningSummary() {
            const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
            const completedOrders = appData.orders.filter(o => o.deliveryBoyId === deliveryBoy?.id && o.status === 'delivered');
            
            const totalEarnings = completedOrders.reduce((sum, order) => sum + (order.deliveryEarning || 0), 0);
            const totalDistance = completedOrders.reduce((sum, order) => sum + (order.deliveryDistance || 0), 0);
            const totalDeliveries = completedOrders.length;
            const avgEarningPerDelivery = totalDeliveries > 0 ? (totalEarnings / totalDeliveries).toFixed(2) : 0;
            
            const html = `
                <div style="background: linear-gradient(135deg, #22c55e 0%, #059669 100%); padding: 20px; border-radius: 12px; color: white;">
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Total Earnings</p>
                    <p style="font-size: 32px; font-weight: 900;">‚Çπ${totalEarnings}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 12px; color: white;">
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Total Distance</p>
                    <p style="font-size: 32px; font-weight: 900;">${totalDistance.toFixed(2)} km</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; color: white;">
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Completed Deliveries</p>
                    <p style="font-size: 32px; font-weight: 900;">${totalDeliveries}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 20px; border-radius: 12px; color: white;">
                    <p style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Avg Per Delivery</p>
                    <p style="font-size: 32px; font-weight: 900;">‚Çπ${avgEarningPerDelivery}</p>
                </div>
            `;
            
            document.getElementById('earningSummary').innerHTML = html;
        }

        function openRechargeModal() {
            const amount = document.getElementById('rechargeAmount').value;
            if (!amount || amount <= 0) {
                showNotification('Please enter valid amount', 'error');
                return;
            }
            
            document.getElementById('rechargeDisplayAmount').textContent = amount;
            document.getElementById('rechargeUpiId').textContent = appData.paymentSettings.upiId;
            document.getElementById('rechargeQrCode').src = appData.paymentSettings.qrCode;
            document.getElementById('rechargeModal').classList.remove('hidden');
            document.getElementById('rechargeModal').style.display = 'flex';
        }

        function closeRechargeModal() {
            document.getElementById('rechargeModal').classList.add('hidden');
            document.getElementById('rechargeModal').style.display = 'none';
        }

        function confirmRecharge() {
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
            
            if (deliveryBoy) {
                deliveryBoy.wallet += amount;
                appData.currentUser.wallet += amount;
                
                // Update users array
                const user = appData.users.find(u => u.id === appData.currentUser.id);
                if (user) user.wallet = appData.currentUser.wallet;
                
                // Add to recharge history
                appData.rechargeHistory.push({
                    id: appData.rechargeHistory.length + 1,
                    deliveryBoyId: deliveryBoy.id,
                    amount: amount,
                    timestamp: new Date().toISOString()
                });
                
                autoSave(); // Save to database
                showNotification(`Wallet recharged with ‚Çπ${amount} successfully!`);
                document.getElementById('rechargeAmount').value = '';
                closeRechargeModal();
                renderDeliveryPanel();
            }
        }

        function renderActiveDeliveries() {
            const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
            const orders = appData.orders.filter(o => o.deliveryBoyId === deliveryBoy?.id && o.status !== 'delivered');
            
            document.getElementById('activeDeliveriesCount').textContent = orders.length;
            
            let html = '';
            if (orders.length === 0) {
                html = '<p class="empty-state"><div class="empty-state-icon">üö¥</div>No active deliveries</p>';
            } else {
                orders.forEach(order => {
                    const restaurant = appData.restaurants.find(r => r.id === order.restaurantId);
                    const user = appData.users.find(u => u.id === order.userId);
                    
                    if (!restaurant || !restaurant.location || !order.userLocation) {
                        html += `
                            <div class="order-card">
                                <p style="color: #dc2626; font-weight: 700;">‚ö†Ô∏è Location information not available for Order #${order.id}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const distance = calculateDistance(
                        restaurant.location.lat, restaurant.location.lng,
                        order.userLocation.lat, order.userLocation.lng
                    );
                    
                    html += `
                        <div class="order-card">
                            <div class="order-info">
                                <h3>Order #${order.id}</h3>
                                <p>Restaurant: ${restaurant?.name}</p>
                                <p>Customer: ${user?.username}</p>
                                <p class="price">Amount: ‚Çπ${order.total}</p>
                                <p>Distance: ${distance.toFixed(2)} km</p>
                            </div>
                            
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 12px;">
                                <p style="font-weight: 700; margin-bottom: 4px;">üìû Customer Contact:</p>
                                <p style="font-size: 16px;"><a href="tel:${user?.phone}" style="color: #92400e; text-decoration: underline;">${user?.phone}</a></p>
                            </div>
                            
                            <div class="location-box">
                                <p><strong>üìç Restaurant Location</strong></p>
                                <p>Lat: ${restaurant.location.lat.toFixed(4)}, Lng: ${restaurant.location.lng.toFixed(4)}</p>
                                <p style="margin-top: 8px;"><strong>üè† Customer Location</strong></p>
                                <p>Lat: ${order.userLocation.lat.toFixed(4)}, Lng: ${order.userLocation.lng.toFixed(4)}</p>
                                <button class="btn-map" onclick="viewOrderOnMap(${order.id})">üó∫Ô∏è View on Map</button>
                            </div>
                            
                            ${order.status === 'assigned' ? `
                                <button class="btn-primary" onclick="pickupOrder(${order.id})">
                                    üì¶ Pickup from Restaurant
                                </button>
                            ` : ''}
                            
                            ${order.status === 'picked' ? `
                                <button class="btn-primary" onclick="arriveAtCustomer(${order.id})">
                                    üìç Arrived at Customer
                                </button>
                            ` : ''}
                            
                            ${order.status === 'arrived' ? `
                                <div>
                                    <p style="font-weight: 700; margin-bottom: 12px;">Payment: ‚Çπ${order.total}</p>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="payment-btn cod" style="flex: 1;" onclick="completeOrder(${order.id}, 'cash')">
                                            üíµ Cash Received
                                        </button>
                                        <button class="payment-btn online" style="flex: 1;" onclick="completeOrder(${order.id}, 'online')">
                                            üí≥ Online Paid
                                        </button>
                                    </div>
                                    <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-top: 12px;">
                                        <p style="font-size: 12px; font-weight: 700; margin-bottom: 4px;">UPI Payment:</p>
                                        <p style="font-size: 12px;">${appData.paymentSettings.upiId}</p>
                                        ${appData.paymentSettings.qrCode ? `
                                            <img src="${appData.paymentSettings.qrCode}" style="width: 128px; height: 128px; margin-top: 8px;">
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            document.getElementById('activeDeliveries').innerHTML = html;
        }

        function pickupOrder(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'picked';
                autoSave(); // Save to database
                showNotification('Order picked up from restaurant!');
                renderActiveDeliveries();
            }
        }

        function arriveAtCustomer(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'arrived';
                autoSave(); // Save to database
                showNotification('Arrived at customer location!');
                renderActiveDeliveries();
            }
        }

        function completeOrder(orderId, paymentMethod) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'delivered';
                order.paymentMethod = paymentMethod;
                
                const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
                
                // Calculate delivery earnings (‚Çπ6 per km)
                const restaurant = appData.restaurants.find(r => r.id === order.restaurantId);
                const distance = calculateDistance(
                    restaurant.location.lat, restaurant.location.lng,
                    order.userLocation.lat, order.userLocation.lng
                );
                const deliveryEarning = Math.round(distance * 6);
                
                // Add earning to delivery boy wallet
                if (deliveryBoy) {
                    deliveryBoy.wallet = (deliveryBoy.wallet || 0) + deliveryEarning;
                    
                    // Update user wallet
                    const user = appData.users.find(u => u.id === appData.currentUser.id);
                    if (user) {
                        user.wallet = (user.wallet || 0) + deliveryEarning;
                        appData.currentUser.wallet = user.wallet;
                    }
                    
                    // If cash payment, deduct order amount from wallet
                    if (paymentMethod === 'cash') {
                        deliveryBoy.wallet -= order.total;
                        if (user) user.wallet -= order.total;
                        appData.currentUser.wallet -= order.total;
                    }
                    
                    // Save earning details in order
                    order.deliveryEarning = deliveryEarning;
                    order.deliveryDistance = distance;
                    
                    autoSave(); // Save to database
                    showNotification(`Order completed! Earned ‚Çπ${deliveryEarning} (${distance.toFixed(2)} km √ó ‚Çπ6/km)`);
                } else {
                    autoSave(); // Save to database
                    showNotification('Order completed successfully!');
                }
                
                renderDeliveryPanel();
            }
        }

        function renderCompletedDeliveries() {
            const deliveryBoy = appData.deliveryBoys.find(d => d.userId === appData.currentUser.id);
            const orders = appData.orders.filter(o => o.deliveryBoyId === deliveryBoy?.id && o.status === 'delivered');
            
            let html = '';
            if (orders.length === 0) {
                html = '<p class="empty-state">No completed deliveries yet</p>';
            } else {
                orders.forEach(order => {
                    html += `
                        <div class="order-card">
                            <div style="display: flex; justify-between; align-items: center;">
                                <div>
                                    <h3>Order #${order.id}</h3>
                                    <p style="font-size: 14px; color: #6b7280;">Payment: ‚Çπ${order.total} (${order.paymentMethod})</p>
                                    ${order.deliveryEarning ? `
                                        <p style="font-size: 14px; color: #059669; font-weight: 700;">
                                            üí∞ Earned: ‚Çπ${order.deliveryEarning} (${order.deliveryDistance.toFixed(2)} km √ó ‚Çπ6/km)
                                        </p>
                                    ` : ''}
                                </div>
                                <span class="badge badge-delivered">Delivered</span>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('completedDeliveries').innerHTML = html;
        }

        // ========== USER PANEL ==========
        function showUserPanel() {
            document.getElementById('userPanel').classList.remove('hidden');
            showRestaurantsList();
        }

        function showRestaurantsList() {
            document.getElementById('userRestaurantsList').classList.remove('hidden');
            document.getElementById('userRestaurantMenu').classList.add('hidden');
            document.getElementById('userCart').classList.add('hidden');
            
            renderRestaurantsList();
            renderMyOrders();
            updateCartButton();
        }

        function renderRestaurantsList() {
            const openRestaurants = appData.restaurants.filter(r => {
                const owner = appData.users.find(u => u.id === r.userId);
                return r.isOpen && owner?.approved;
            });
            
            document.getElementById('openRestaurantsCount').textContent = openRestaurants.length;
            
            let html = '';
            if (openRestaurants.length === 0) {
                html = '<p class="empty-state"><div class="empty-state-icon">üè™</div>No open restaurants</p>';
            } else {
                openRestaurants.forEach(restaurant => {
                    const itemCount = appData.menuItems.filter(m => m.restaurantId === restaurant.id).length;
                    html += `
                        <div class="restaurant-card" onclick="selectRestaurant(${restaurant.id})">
                            <div class="restaurant-header">
                                <div class="restaurant-icon">üçΩÔ∏è</div>
                                <div>
                                    <h3 style="font-weight: 900; font-size: 18px;">${restaurant.name}</h3>
                                    <p style="font-size: 14px; color: #6b7280;">${itemCount} items</p>
                                </div>
                            </div>
                            <div class="restaurant-footer">
                                <span class="badge badge-open">üü¢ Open</span>
                                <button class="btn" style="background: #f97316; color: white;">View Menu</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('restaurantsList').innerHTML = html;
        }

        function selectRestaurant(restaurantId) {
            appData.selectedRestaurant = appData.restaurants.find(r => r.id === restaurantId);
            document.getElementById('userRestaurantsList').classList.add('hidden');
            document.getElementById('userRestaurantMenu').classList.remove('hidden');
            document.getElementById('selectedRestaurantName').textContent = appData.selectedRestaurant.name + ' Menu';
            renderMenuItems();
        }

        function backToRestaurants() {
            showRestaurantsList();
        }

        function renderMenuItems() {
            const items = appData.menuItems.filter(item => item.restaurantId === appData.selectedRestaurant.id);
            
            let html = '';
            if (items.length === 0) {
                html = '<p class="empty-state">No menu items available</p>';
            } else {
                items.forEach(item => {
                    html += `
                        <div class="item-card">
                            <img src="${item.image}" alt="${item.name}">
                            <div class="item-card-content">
                                <h3 style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">${item.name}</h3>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="price" style="font-size: 20px;">‚Çπ${item.price}</span>
                                    <button class="btn" style="background: #f97316; color: white;" onclick='addToCart(${JSON.stringify(item)})'>Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('menuItemsList').innerHTML = html;
        }

        function addToCart(item) {
            const existing = appData.cart.find(c => c.id === item.id);
            if (existing) {
                existing.quantity++;
            } else {
                appData.cart.push({...item, quantity: 1});
            }
            showNotification(`${item.name} added to cart!`);
            updateCartButton();
        }

        function updateCartButton() {
            const cartBtn = document.getElementById('cartBtn');
            const cartCount = document.getElementById('cartCount');
            
            if (appData.cart.length > 0) {
                cartBtn.style.display = 'inline-flex';
                cartCount.textContent = appData.cart.length;
            } else {
                cartBtn.style.display = 'none';
            }
        }

        function viewCart() {
            document.getElementById('userRestaurantsList').classList.add('hidden');
            document.getElementById('userRestaurantMenu').classList.add('hidden');
            document.getElementById('userCart').classList.remove('hidden');
            renderCart();
        }

        function backToMenu() {
            if (appData.selectedRestaurant) {
                document.getElementById('userCart').classList.add('hidden');
                document.getElementById('userRestaurantMenu').classList.remove('hidden');
            } else {
                showRestaurantsList();
            }
        }

        function renderCart() {
            // Initialize user location if not set
            if (!appData.userLocation) {
                appData.userLocation = {
                    lat: narsinghpurCenter.lat + (Math.random() - 0.5) * 0.02,
                    lng: narsinghpurCenter.lng + (Math.random() - 0.5) * 0.02
                };
            }
            
            // Update location inputs
            document.getElementById('userLat').value = appData.userLocation.lat.toFixed(4);
            document.getElementById('userLng').value = appData.userLocation.lng.toFixed(4);
            document.getElementById('userCurrentLocation').innerHTML = `
                <p style="font-weight: 700; margin-bottom: 4px;">Current Delivery Location:</p>
                <p style="font-size: 14px; color: #4b5563;">Latitude: ${appData.userLocation.lat.toFixed(4)}</p>
                <p style="font-size: 14px; color: #4b5563;">Longitude: ${appData.userLocation.lng.toFixed(4)}</p>
            `;
            
            // Cart Items
            let cartHtml = '';
            if (appData.cart.length === 0) {
                cartHtml = '<p class="empty-state">Cart is empty</p>';
            } else {
                appData.cart.forEach(item => {
                    cartHtml += `
                        <div class="cart-item">
                            <div style="flex: 1;">
                                <h3 style="font-weight: 700;">${item.name}</h3>
                                <p style="font-size: 14px; color: #6b7280;">‚Çπ${item.price} x ${item.quantity}</p>
                            </div>
                            <div class="quantity-controls">
                                <button class="qty-btn minus" onclick="removeFromCart(${item.id})">‚àí</button>
                                <span style="font-weight: 700;">${item.quantity}</span>
                                <button class="qty-btn plus" onclick='addToCart(${JSON.stringify(item)})'>+</button>
                            </div>
                        </div>
                    `;
                });
            }
            document.getElementById('cartItems').innerHTML = cartHtml;
            
            // Bill Summary
            const subtotal = appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const restaurant = appData.restaurants.find(r => appData.menuItems.find(m => m.id === appData.cart[0]?.id)?.restaurantId === r.id);
            const distance = restaurant && restaurant.location ? calculateDistance(
                restaurant.location.lat, restaurant.location.lng,
                appData.userLocation.lat, appData.userLocation.lng
            ) : 0;
            const deliveryCharge = Math.ceil(distance * 10);
            const discount = appData.selectedCoupon ? appData.selectedCoupon.discount : 0;
            const total = subtotal + deliveryCharge - discount;
            
            let billHtml = `
                <div class="bill-row">
                    <span>Subtotal</span>
                    <span>‚Çπ${subtotal}</span>
                </div>
                <div class="bill-row">
                    <span>Delivery (${distance.toFixed(2)} km @ ‚Çπ10/km)</span>
                    <span>‚Çπ${deliveryCharge}</span>
                </div>
            `;
            
            if (discount > 0) {
                billHtml += `
                    <div class="bill-row" style="color: #059669;">
                        <span>Discount</span>
                        <span>-‚Çπ${discount}</span>
                    </div>
                `;
            }
            
            billHtml += `
                <div class="bill-row bill-total">
                    <span>Total</span>
                    <span>‚Çπ${total}</span>
                </div>
            `;
            
            document.getElementById('billSummary').innerHTML = billHtml;
            
            // Payment QR
            if (appData.paymentSettings.qrCode) {
                document.getElementById('paymentQr').innerHTML = `
                    <p style="font-size: 14px; font-weight: 700; margin-top: 16px;">Scan to Pay:</p>
                    <img src="${appData.paymentSettings.qrCode}" alt="QR Code">
                    <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">${appData.paymentSettings.upiId}</p>
                `;
            }
        }

        function updateUserLocation() {
            const lat = parseFloat(document.getElementById('userLat').value);
            const lng = parseFloat(document.getElementById('userLng').value);
            
            if (!lat || !lng) {
                showNotification('Please enter valid latitude and longitude', 'error');
                return;
            }
            
            appData.userLocation = { lat, lng };
            showNotification('Delivery location updated!');
            renderCart();
        }

        function removeFromCart(itemId) {
            const existing = appData.cart.find(c => c.id === itemId);
            if (existing) {
                if (existing.quantity > 1) {
                    existing.quantity--;
                } else {
                    appData.cart = appData.cart.filter(c => c.id !== itemId);
                }
                renderCart();
                updateCartButton();
            }
        }

        function applyCoupon() {
            const code = document.getElementById('couponInput').value.toUpperCase();
            const coupon = appData.coupons.find(c => c.code === code);
            
            if (coupon) {
                const subtotal = appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                if (subtotal >= coupon.minOrder) {
                    appData.selectedCoupon = coupon;
                    document.getElementById('couponMessage').innerHTML = `
                        <p style="color: #059669; font-weight: 700;">‚úì ${coupon.code} applied - ‚Çπ${coupon.discount} off</p>
                    `;
                    renderCart();
                } else {
                    document.getElementById('couponMessage').innerHTML = `
                        <p style="color: #dc2626; font-weight: 700;">Minimum order ‚Çπ${coupon.minOrder} required</p>
                    `;
                }
            } else {
                document.getElementById('couponMessage').innerHTML = `
                    <p style="color: #dc2626; font-weight: 700;">Invalid coupon code</p>
                `;
            }
        }

        function placeOrder(paymentMethod) {
            if (appData.cart.length === 0) return;
            
            if (!appData.userLocation) {
                showNotification('Please set your delivery location first!', 'error');
                return;
            }
            
            const restaurant = appData.restaurants.find(r => appData.menuItems.find(m => m.id === appData.cart[0].id)?.restaurantId === r.id);
            
            if (!restaurant || !restaurant.location) {
                showNotification('Restaurant location not available', 'error');
                return;
            }
            
            const distance = calculateDistance(
                restaurant.location.lat, restaurant.location.lng,
                appData.userLocation.lat, appData.userLocation.lng
            );
            
            const subtotal = appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryCharge = Math.ceil(distance * 10);
            const discount = appData.selectedCoupon ? appData.selectedCoupon.discount : 0;
            const total = subtotal + deliveryCharge - discount;
            
            // If online payment, show payment modal first
            if (paymentMethod === 'online') {
                appData.pendingPayment = {
                    restaurantId: restaurant.id,
                    items: [...appData.cart],
                    subtotal,
                    deliveryCharge,
                    discount,
                    total,
                    userLocation: { ...appData.userLocation }
                };
                
                document.getElementById('paymentAmount').textContent = total;
                document.getElementById('paymentUpiId').textContent = appData.paymentSettings.upiId;
                document.getElementById('paymentQrCode').src = appData.paymentSettings.qrCode;
                document.getElementById('paymentModal').classList.remove('hidden');
                document.getElementById('paymentModal').style.display = 'flex';
                return;
            }
            
            // For COD, place order directly
            createOrder(paymentMethod, {
                restaurantId: restaurant.id,
                items: [...appData.cart],
                subtotal,
                deliveryCharge,
                discount,
                total,
                userLocation: { ...appData.userLocation }
            });
        }

        function confirmOnlinePayment() {
            if (!appData.pendingPayment) return;
            
            createOrder('online', appData.pendingPayment);
            
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').style.display = 'none';
            appData.pendingPayment = null;
        }

        function cancelPayment() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').style.display = 'none';
            appData.pendingPayment = null;
            showNotification('Order cancelled', 'error');
        }

        function createOrder(paymentMethod, orderData) {
            const newOrder = {
                id: appData.orders.length + 1,
                userId: appData.currentUser.id,
                restaurantId: orderData.restaurantId,
                items: orderData.items,
                subtotal: orderData.subtotal,
                deliveryCharge: orderData.deliveryCharge,
                discount: orderData.discount,
                total: orderData.total,
                status: 'pending',
                paymentMethod,
                userLocation: orderData.userLocation,
                createdAt: new Date().toISOString()
            };
            
            appData.orders.push(newOrder);
            appData.cart = [];
            appData.selectedCoupon = null;
            document.getElementById('couponInput').value = '';
            
            autoSave(); // Save to database
            showNotification('Order placed successfully!');
            showRestaurantsList();
        }

        function shareApp() {
            alert(`Share this link with friends:\n\nfoodexpress.com/ref/${appData.currentUser.id}\n\nBoth you and your friend will get ‚Çπ50 discount on orders above ‚Çπ200!`);
        }

        function renderMyOrders() {
            const myOrders = appData.orders.filter(o => o.userId === appData.currentUser.id);
            
            document.getElementById('myOrdersCount').textContent = myOrders.length;
            
            let html = '';
            if (myOrders.length === 0) {
                html = '<p class="empty-state"><div class="empty-state-icon">üì¶</div>No orders yet. Start ordering!</p>';
            } else {
                myOrders.forEach(order => {
                    const restaurant = appData.restaurants.find(r => r.id === order.restaurantId);
                    const deliveryBoy = order.deliveryBoyId ? appData.deliveryBoys.find(d => d.id === order.deliveryBoyId) : null;
                    const deliveryUser = deliveryBoy ? appData.users.find(u => u.id === deliveryBoy.userId) : null;
                    
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-info">
                                    <h3>Order #${order.id}</h3>
                                    <p>${restaurant?.name}</p>
                                    <p>Items: ${order.items.map(i => i.name).join(', ')}</p>
                                    <p class="price">‚Çπ${order.total}</p>
                                </div>
                                <span class="badge badge-${order.status}">${order.status}</span>
                            </div>
                            
                            ${order.status !== 'pending' && order.status !== 'rejected' ? `
                                <div class="order-status-progress">
                                    <div class="status-step ${order.status === 'accepted' ? 'active' : 'completed'}">
                                        <div class="status-icon ${order.status === 'accepted' ? 'active' : 'completed'}">üë®‚Äçüç≥</div>
                                        <div>
                                            <strong>Order Accepted</strong>
                                            <p style="font-size: 12px; color: #6b7280;">${order.status === 'accepted' ? 'Preparing your order...' : 'Order prepared'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="status-step ${order.status === 'assigned' ? 'active' : (order.status === 'picked' || order.status === 'arrived' || order.status === 'delivered' ? 'completed' : 'pending')}">
                                        <div class="status-icon ${order.status === 'assigned' ? 'active' : (order.status === 'picked' || order.status === 'arrived' || order.status === 'delivered' ? 'completed' : 'pending')}">üö¥</div>
                                        <div>
                                            <strong>Delivery Boy Assigned</strong>
                                            <p style="font-size: 12px; color: #6b7280;">${order.deliveryBoyId ? 'On the way to restaurant' : 'Waiting for delivery boy'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="status-step ${order.status === 'picked' ? 'active' : (order.status === 'arrived' || order.status === 'delivered' ? 'completed' : 'pending')}">
                                        <div class="status-icon ${order.status === 'picked' ? 'active' : (order.status === 'arrived' || order.status === 'delivered' ? 'completed' : 'pending')}">üì¶</div>
                                        <div>
                                            <strong>Order Picked Up</strong>
                                            <p style="font-size: 12px; color: #6b7280;">${order.status === 'picked' ? 'On the way to your location' : 'Pending pickup'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="status-step ${order.status === 'arrived' ? 'active' : (order.status === 'delivered' ? 'completed' : 'pending')}">
                                        <div class="status-icon ${order.status === 'arrived' ? 'active' : (order.status === 'delivered' ? 'completed' : 'pending')}">üè†</div>
                                        <div>
                                            <strong>Arrived</strong>
                                            <p style="font-size: 12px; color: #6b7280;">${order.status === 'arrived' ? 'Delivery boy at your location' : order.status === 'delivered' ? 'Delivered' : 'Not yet arrived'}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${deliveryBoy && deliveryUser ? `
                                <div class="delivery-info-card">
                                    <h3>üö¥ Your Delivery Partner</h3>
                                    <p>${deliveryUser.username}</p>
                                    <p>üìû <a href="tel:${deliveryUser.phone}">${deliveryUser.phone}</a></p>
                                    ${deliveryBoy.location ? `
                                        <p style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                                            üìç Current Location: ${deliveryBoy.location.lat.toFixed(4)}, ${deliveryBoy.location.lng.toFixed(4)}
                                        </p>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            document.getElementById('myOrdersList').innerHTML = html;
        }

        // ========== MAP FUNCTIONS ==========
        function openMapSelector(type) {
            appData.mapSelector.type = type;
            document.getElementById('mapModal').classList.remove('hidden');
            document.getElementById('mapModal').style.display = 'flex';
            
            // Reset marker
            document.getElementById('mapMarker').classList.add('hidden');
            document.getElementById('selectedLat').textContent = '-';
            document.getElementById('selectedLng').textContent = '-';
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.add('hidden');
            document.getElementById('mapModal').style.display = 'none';
            appData.mapSelector = { type: null, callback: null };
        }

        function handleMapClick(event) {
            const mapCanvas = document.getElementById('mapCanvas');
            const rect = mapCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Convert pixel coordinates to lat/lng (simple mapping)
            // Narsinghpur area: lat 22.90-22.93, lng 78.98-79.02
            const lat = 22.93 - (y / rect.height) * 0.03;
            const lng = 78.98 + (x / rect.width) * 0.04;
            
            // Update marker position
            const marker = document.getElementById('mapMarker');
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.classList.remove('hidden');
            
            // Update display
            document.getElementById('selectedLat').textContent = lat.toFixed(4);
            document.getElementById('selectedLng').textContent = lng.toFixed(4);
            
            appData.mapSelector.selectedLocation = { lat, lng };
        }

        function confirmMapLocation() {
            if (!appData.mapSelector.selectedLocation) {
                showNotification('Please select a location on the map', 'error');
                return;
            }
            
            const { lat, lng } = appData.mapSelector.selectedLocation;
            
            if (appData.mapSelector.type === 'restaurant') {
                document.getElementById('restaurantLat').value = lat.toFixed(4);
                document.getElementById('restaurantLng').value = lng.toFixed(4);
                updateRestaurantLocation();
            } else if (appData.mapSelector.type === 'user') {
                document.getElementById('userLat').value = lat.toFixed(4);
                document.getElementById('userLng').value = lng.toFixed(4);
                updateUserLocation();
            }
            
            closeMapModal();
        }

        function viewOrderOnMap(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const restaurant = appData.restaurants.find(r => r.id === order.restaurantId);
            if (!restaurant || !restaurant.location || !order.userLocation) {
                showNotification('Location data not available', 'error');
                return;
            }
            
            // Show modal
            document.getElementById('orderMapModal').classList.remove('hidden');
            document.getElementById('orderMapModal').style.display = 'flex';
            
            // Update location info
            document.getElementById('orderRestaurantLoc').textContent = 
                `Lat: ${restaurant.location.lat.toFixed(4)}, Lng: ${restaurant.location.lng.toFixed(4)}`;
            document.getElementById('orderCustomerLoc').textContent = 
                `Lat: ${order.userLocation.lat.toFixed(4)}, Lng: ${order.userLocation.lng.toFixed(4)}`;
            
            const distance = calculateDistance(
                restaurant.location.lat, restaurant.location.lng,
                order.userLocation.lat, order.userLocation.lng
            );
            document.getElementById('orderDistance').textContent = distance.toFixed(2);
            
            // Calculate marker positions (simple mapping)
            const mapCanvas = document.getElementById('orderMapCanvas');
            const rect = mapCanvas.getBoundingClientRect();
            
            // Map area: lat 22.90-22.93, lng 78.98-79.02
            const restaurantX = ((restaurant.location.lng - 78.98) / 0.04) * rect.width;
            const restaurantY = ((22.93 - restaurant.location.lat) / 0.03) * rect.height;
            const customerX = ((order.userLocation.lng - 78.98) / 0.04) * rect.width;
            const customerY = ((22.93 - order.userLocation.lat) / 0.03) * rect.height;
            
            // Position markers
            const restaurantMarker = document.getElementById('restaurantMarker');
            const customerMarker = document.getElementById('customerMarker');
            
            restaurantMarker.style.left = restaurantX + 'px';
            restaurantMarker.style.top = restaurantY + 'px';
            restaurantMarker.style.display = 'block';
            
            customerMarker.style.left = customerX + 'px';
            customerMarker.style.top = customerY + 'px';
            customerMarker.style.display = 'block';
            
            // Draw route line
            const svg = document.getElementById('routeLine');
            svg.innerHTML = `
                <line x1="${restaurantX}" y1="${restaurantY}" x2="${customerX}" y2="${customerY}" 
                      stroke="#3b82f6" stroke-width="3" stroke-dasharray="5,5"/>
            `;
        }

        function closeOrderMapModal() {
            document.getElementById('orderMapModal').classList.add('hidden');
            document.getElementById('orderMapModal').style.display = 'none';
            document.getElementById('restaurantMarker').style.display = 'none';
            document.getElementById('customerMarker').style.display = 'none';
        }

        // Initialize app
        window.onload = async function() {
            console.log('üöÄ Starting FoodExpress System...');
            
            // Load data from database
            const dataLoaded = await loadFromDatabase();
            
            if (dataLoaded) {
                console.log('üì¶ Database Status: Connected');
                console.log('üë• Total Users:', appData.users.length);
                console.log('üè™ Total Restaurants:', appData.restaurants.length);
                console.log('üì¶ Total Orders:', appData.orders.length);
                console.log('üö¥ Total Delivery Boys:', appData.deliveryBoys.length);
            } else {
                console.log('üì¶ Database Status: New Installation');
                // Save initial data
                autoSave();
            }
            
            // Add database status to console
            console.log('‚úÖ FoodExpress System Ready');
            if (isFirebaseConnected) {
                console.log('üåê Firebase Cloud Database Active');
                console.log('üîÑ Real-time sync enabled');
            } else {
                console.log('üíæ LocalStorage Fallback Active');
            }
        };
    </script>
</body>
</html>
